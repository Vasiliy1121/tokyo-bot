import openai
import re
import os

openai.api_key = os.getenv("OPENAI_API_KEY")

async def generate_itinerary(data):
    prompt = f"""
    –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—É—Ä–∏–∑–º—É –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≥–∏–¥ –≤ –Ø–ø–æ–Ω–∏–∏, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ –¢–æ–∫–∏–æ.

    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –º–∞—Ä—à—Ä—É—Ç:

    1. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {data['days']} –¥–Ω–µ–π.
    2. –°–æ—Å—Ç–∞–≤: {data['travelers']}.
    3. –ò–Ω—Ç–µ—Ä–µ—Å—ã: {data['interests']}.
    4. –¢–µ–º–ø: {data['pace']}.
    5. –ë—é–¥–∂–µ—Ç: {data['budget']}.
    6. –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≤ –µ–¥–µ: {data['food']}.
    7. –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: {data['special_requests']}.

    –°–æ—Å—Ç–∞–≤—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ –¥–Ω—è–º (–£—Ç—Ä–æ, –î–µ–Ω—å, –í–µ—á–µ—Ä). –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
    """

    client = openai.OpenAI()
    response = client.chat.completions.create(
        model="gpt-4-1106-preview",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7,
        max_tokens=3000
    )

    itinerary = response.choices[0].message.content.strip()
    return add_google_maps_links(itinerary)


async def edit_day(current_itinerary, day_number, user_request):
    day_pattern = rf"(üìÖ?\s*–î–µ–Ω—å\s*{day_number}.*?)(?=(üìÖ?\s*–î–µ–Ω—å\s*\d+)|\Z)"
    match = re.search(day_pattern, current_itinerary, re.DOTALL)

    if not match:
        raise ValueError(f"–ù–µ –Ω–∞–π–¥–µ–Ω –î–µ–Ω—å {day_number}")

    day_text = match.group(1).strip()

    prompt = f"""
    –¢–µ–∫—É—â–∏–π –î–µ–Ω—å {day_number}:

    {day_text}

    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥–µ–Ω—å —Ç–∞–∫:
    "{user_request}"

    –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π –î–µ–Ω—å {day_number}, —É—á—Ç—è –ø–æ–∂–µ–ª–∞–Ω–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–£—Ç—Ä–æ, –î–µ–Ω—å, –í–µ—á–µ—Ä).
    """

    client = openai.OpenAI()
    response = client.chat.completions.create(
        model="gpt-4-1106-preview",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7,
        max_tokens=1500
    )

    edited_day_text = response.choices[0].message.content.strip()
    new_itinerary = current_itinerary.replace(day_text, edited_day_text)

    return new_itinerary


def add_google_maps_links(itinerary_text):
    # –°–æ–∑–¥–∞—ë–º markdown-—Å—Å—ã–ª–∫—É
    def make_link(place):
        query = place.strip().replace(' ', '+')
        return f"[{place}](https://www.google.com/maps/search/?api=1&query={query})"

    # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≤ —Å–∫–æ–±–∫–∞—Ö –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
    pattern_brackets = re.compile(r'([–ê-–Ø–∞-—è–Å—ë\s]+)\s*\(([\w\s\'&-]+)\)')

    # –°–Ω–∞—á–∞–ª–∞ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ "–†—É—Å—Å–∫–æ–µ (English)"
    itinerary_text = pattern_brackets.sub(lambda m: f"{m.group(1).strip()} ({make_link(m.group(2).strip())})", itinerary_text)

    # –ó–∞—Ç–µ–º –Ω–∞—Ö–æ–¥–∏–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –±–µ–∑ —Å–∫–æ–±–æ–∫
    english_place_pattern = re.compile(r'\b([A-Z][A-Za-z0-9&\'\-]+\s?(Park|Museum|City|Center|Plaza|Garden|Shrine|Temple|Bridge|Station|Tower|Broadway|Market|Cafe|Restaurant|Hall|Disneyland|DisneySea|Animate|Mandarake|Gundam|Pok√©mon|Sunshine|Nakano|Asakusa|Akihabara|Ikebukuro|Ueno|Odaiba|Fuji|Miraikan|Sumida|Hibiya|Marunouchi))\b')

    itinerary_text = english_place_pattern.sub(lambda m: make_link(m.group(1)), itinerary_text)

    return itinerary_text



